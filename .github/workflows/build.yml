name: build
on:
  pull_request:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-18.04
    container:
      image: ubuntu:focal
    steps:
      - name: Accept EULAs
        env:
          DEBIAN_FRONTEND: noninteractive
          DEBCONF_NONINTERACTIVE_SEEN: "true"
        run: echo ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true | debconf-set-selections
      - name: Install dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
          DEBCONF_NONINTERACTIVE_SEEN: "true"
        run: >
          apt-get update && apt-get install -y -q
          autoconf
          bison
          build-essential
          cmake
          flex
          gettext
          git-core
          intltool
          libglib2.0-dev
          libtool
          meson
          mingw-w64
          ninja-build
          nsis
          pkg-config
          protobuf-compiler
          python3
          python3-setuptools
          stow
          sudo
          texinfo
          unzip
          wget
          wine-stable
          yasm
      - name: Configure Mingw for POSIX threads
        run: update-alternatives --set x86_64-w64-mingw32-gcc /usr/bin/x86_64-w64-mingw32-gcc-posix
      - name: Configure Mingw for POSIX threads
        run: update-alternatives --set x86_64-w64-mingw32-g++ /usr/bin/x86_64-w64-mingw32-g++-posix
      - name: Checkout
        uses: actions/checkout@v2
        with:
          path: deps
      - name: Fix source path
        run: mv deps /src
      - name: Create target directory
        run: mkdir -p /target/stow
      - name: Build dependencies
        working-directory: /src/windows
        run: make
